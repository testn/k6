k6 v0.32.0 is here! :tada: It's a smaller release with mostly chore tasks that we never got to or that needed to be done in this release cycle, but does also include a significant performance improvement for arrival rate.

## Move out of Bintray

Bintray has [stopped servicing users on 1st of May](https://jfrog.com/blog/into-the-sunset-bintray-jcenter-gocenter-and-chartcenter/), which meant that we needed to move the deb and rpm repository out of there before that. Unfortunately there was no time to squeeze this in the previous release. Please follow the new [installation instructions](https://k6.io/docs/getting-started/installation/) and the "Note about Bintray" to find out how to remove the old repository if you have used them.

## Notable changes

### Rewrite all collectors to new Output interface introduced in v0.31.0 and other related changes

In the previous release v0.31.0 we started on this and now all internal outputs implement the new Output interface. Additionally 2 outputs are being deprecated:

1. The kafka output has been neglected and not really taken care of since it was added 3 years ago. Additionally it does bring a lot of complexity and isn't really well understood by anyone on the team. Given that since last version we can have [output extension](https://github.com/k6io/xk6-output-kafka) it is now moved to one. It will continue to work for some more versions, but it will be dropped and the extension will be needed.
2. The datadog output should've probably always been just a configuration of the statsd one and it is now just that. The new configuration is `K6_STATSD_ENABLE_TAGS` which is `false` by default, but enabling will send tags the same way `datadog` did before. This can be used also for anything that supports the same tag format such as: New Relic, Amazon Cloudwatch and statsd >v0.9.0. Additionally `K6_STATSD_TAG_BLOCKLIST` can be used to *not* send tags that the user doesn't want to.

Apart from a message about them being deprecated, nothing should be changed, but we advice users to start using the proposed alternatives, during this release cycle.

#### `json` output emits thresholds defined on the metrics [#1886](https://github.com/k6io/k6/pull/1886) thanks to @codebien

Previous to this if you have defined a threshold and used the `json` output that wouldn't have been seen in the json output, now the `Metric` json object will get it's `thresholds` field properly populated.

#### `cloud` output has an option to abort the test if aborted from the cloud [#1965](https://github.com/k6io/k6/pull/1965)

In v0.26.0 we made the cloud output to [stop emit metrics](https://github.com/k6io/k6/pull/1130) if it gets a particular error from the cloud, as that meant that the test was aborted in the cloud. Now we added `K6_CLOUD_ABORT_ON_ERROR` to be able to say that it should not only stop emitting tests but also stop the execution of k6. The default configuration is `false` - so it is backwards compatible. This does works with aborting the test by the user and hitting on of the cloud limits which would lead to the test being aborted.


### Full stack traces for init context and setup/teardown exceptions [#1971](https://github.com/k6io/k6/pull/1971)

For a long time if there was an exception in either init context or in `setup` or `teardown` invocations, the stack trace will be just the last line, making it really hard to debug issues there. Now there is a full stack trace and as such errors will result in aborted k6 execution it will also exit with exit code `107` signalling a script error.


### Considerable performance improvements for arrival rate executors [#1955](https://github.com/k6io/k6/pull/1955)

Due to a *wrong* reusage for a particular internal structure the arrival rate executors in particular were having a much worse performance then expected. With this release they should be more then 5x as performant, especially with multiple VUs.


### Updating the majority of our dependencies and dropping some

The list is too long and we have been postponing updating for quite some time now, but we have finally updated all our dependencies that we don't want to drop. This could lead to some stability problems, which is why it was done early on in the cycle. While the team has not found any regressions, given all the updates we could have missed something so please [open a issue](https://github.com/k6io/k6/issues) if you found anything.

Some notable updates:
- goja, the JS engine we use got support for let/const which let us disable a babel plugin. Previous to this if you had a particularly *long* script sometimes babel took upwards for 30 minutes to transpile. Now even our worst contender taking 51minutes took less than a minute :tada:. Also `globalThis` is now available.
- updating the gRPC libraries fixed bug [#1928](https://github.com/k6io/k6/issues/1928) and probably others. [#1937](https://github.com/k6io/k6/pull/1937)

## Other enhancements and UX improvements

- JS: `ArrayBuffer` is now supported for binary data throughout the codebase, including in WebSocket messages. [#1841](https://github.com/k6io/k6/pull/1841)

  It's now possible to send binary WS messages with the `socket.sendBinary()` function and to receive binary messages with the `binaryMessage` event handler:

  ```javascript
  const binFile = open('./file.pdf', 'b');

  export default function () {
    ws.connect('http://wshost/', function(socket) {
      socket.on('open', function() {
        socket.sendBinary(binFile);
      });

      socket.on('binaryMessage', function(msg) {
        // msg is an ArrayBuffer, so we can wrap it in a typed array directly.
        new Uint8Array(msg);
      });
    });
  }
  ```

  For the other backwards incompatible changes see below.

- Options: K6 should now warn you on unrecognised configuration js options in most cases instead of just silently ignoring them. [#1919](https://github.com/k6io/k6/pull/1919)
- error_code: the tag `error_code` should now be set more accurately in some cases. [#1952](https://github.com/k6io/k6/pull/1951)

## Bugs fixed!

- Arrival rate executors could in some cases report twice as many used VUs then what was true. [#1954](https://github.com/k6io/k6/issues/1954) fixed by [#1955](https://github.com/k6io/k6/pull/1955)
- The newly added `responseCallback` in v0.31.0, would in cases of a response erroring mid reading the body be evaluated with the returned status code, while the reported one will be `0` as the response errored out and k6 does not return half response. Now responseCallback will receive status `0`. [#1962](https://github.com/k6io/k6/pull/1962)
- Fix kafka output not being usable with influxdb format after v0.31.0 changes. [#1914](https://github.com/k6io/k6/pull/1914)
- Error out with a nice message if `ramping-vus` executor would've not run a single iteration instead of just doing nothing. [#1942](https://github.com/k6io/k6/pull/1942)

## Internals

- JS: Way for js modules to have per VU initialization and object. This can also be used by xk6 modules by implementing `github.com/loadimpact/k6/js/modules#HasModuleInstancePerVU`. Part of [#1911](https://github.com/k6io/k6/pull/1911)


## Breaking changes

- JS: The expanded support for `ArrayBuffer`, continued from [v0.31.0](https://github.com/k6io/k6/releases/tag/v0.31.0), introduces some changes that might break current scripts that relied on the previous array of integers values returned by some of our internal APIs. Specifically these cases now return `ArrayBuffer` instead: `open(..., 'b')`, binary response bodies for requests that specified `responseType: 'binary'` (including when `http.batch()` is used), `crypto.randomBytes()`, `hasher.digest('binary')` and `encoding.b64decode()`.
  The previous default behavior of returning string from `encoding.b64decode()` can be replicated with a new optional `format` argument and a value of `"s"`: `encoding.b64decode("5bCP6aO85by-Li4=", "url", "s")`.
  Most of these shouldn't cause issues if the script is simply passing the values to another k6 API (e.g. opening a file as binary and passing it to `http.post()`), but in other cases the script will need to be modified to wrap the `ArrayBuffer` in a [typed array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays) and use that API instead.
